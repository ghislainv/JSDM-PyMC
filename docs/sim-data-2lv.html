<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-05-17 Wed 18:22 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ordering species to correct for ineffective constraints in joint species distribution models with latent variables</title>
<meta name="author" content="Ghislain Vieilledent" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xz/fonts@1/serve/inter.css">
<link rel="stylesheet" href="style/new.css">
<link rel="stylesheet" href="style/mycss.css">
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Ordering species to correct for ineffective constraints in joint species distribution models with latent variables</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org132ef96">1. Installing PyMC in a Python virtual environment</a></li>
<li><a href="#org847f8e8">2. Import libraries</a></li>
<li><a href="#orgd4a7ec8">3. Functions</a></li>
<li><a href="#orgb838cff">4. Simulating data</a></li>
<li><a href="#org73641b9">5. Model</a></li>
<li><a href="#org0a33115">6. Convergence and model performance</a>
<ul>
<li><a href="#org49f2b63">6.1. Plotting traces</a></li>
<li><a href="#org4ee1fb5">6.2. Parameter estimates.</a></li>
<li><a href="#org134d7ad">6.3. Traces for constrained parameters</a>
<ul>
<li><a href="#orgcaccb06">6.3.1. Factor loadings on the diagonal</a></li>
<li><a href="#orgdf7327c">6.3.2. Species with high factor loadings</a></li>
</ul>
</li>
<li><a href="#org1dcc0a8">6.4. Convergence criteria</a></li>
<li><a href="#org696fda3">6.5. Predicted vs. target parameter values</a></li>
</ul>
</li>
<li><a href="#org8960fa0">7. Correcting for species order</a>
<ul>
<li><a href="#org6d113de">7.1. Sorting species</a></li>
<li><a href="#org7d98440">7.2. Statistical model</a></li>
<li><a href="#org3f2b777">7.3. Convergence and model performance</a></li>
<li><a href="#org284988e">7.4. Predicted vs. target parameter values</a></li>
</ul>
</li>
<li><a href="#org861894b">8. Automatic sorting of species with PCAÂ on residuals</a>
<ul>
<li><a href="#orgdbc8081">8.1. Unsorted data</a></li>
<li><a href="#org4c68651">8.2. Statistical model with residuals</a></li>
<li><a href="#orgb0683f5">8.3. PCA on residuals</a></li>
<li><a href="#orgfda95c2">8.4. Correlation between loadings and species coordinates on the PCA axis</a></li>
<li><a href="#orgff4ebc0">8.5. Statistical model with sorted species</a></li>
<li><a href="#org0a44c08">8.6. Convergence and model performance</a></li>
<li><a href="#org3b27aa9">8.7. Predicted vs. target parameter values</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-org132ef96" class="outline-2">
<h2 id="org132ef96"><span class="section-number-2">1.</span> Installing PyMC in a Python virtual environment</h2>
<div class="outline-text-2" id="text-1">
<p>
The best way to install the package is to create a Python virtual environment, for example using <code>conda</code>. You first need to have <a href="https://docs.conda.io/en/latest/miniconda.html">miniconda3</a> installed. Then, create a <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html">conda environment</a> and install the PyMC package with the following commands:
</p>

<div class="org-src-container">
<pre class="src src-shell">conda create --name JSDM-PyMC -c conda-forge <span class="org-variable-name">python</span>=3.9
conda activate JSDM-PyMC
conda install -c conda-forge mamba
mamba install -c conda-forge <span class="org-string">"pymc&gt;=4"</span>
conda install -c conda-forge scikit-learn flake8 jedi tabular
</pre>
</div>

<p>
To deactivate and delete the conda environment, use the following commands:
</p>

<div class="org-src-container">
<pre class="src src-shell">conda deactivate
conda env remove --name JSDM-PyMC
</pre>
</div>
</div>
</div>

<div id="outline-container-org847f8e8" class="outline-2">
<h2 id="org847f8e8"><span class="section-number-2">2.</span> Import libraries</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> os
<span class="org-keyword">import</span> sys

<span class="org-keyword">import</span> arviz <span class="org-keyword">as</span> az
<span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt
<span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">import</span> pandas <span class="org-keyword">as</span> pd
<span class="org-keyword">import</span> cloudpickle
<span class="org-keyword">import</span> pymc <span class="org-keyword">as</span> pm
<span class="org-keyword">import</span> pytensor.tensor <span class="org-keyword">as</span> pt
<span class="org-keyword">from</span> tabulate <span class="org-keyword">import</span> tabulate

<span class="org-builtin">print</span>(f<span class="org-string">"Running on PyMC v</span>{pm.__version__}<span class="org-string">"</span>)
</pre>
</div>

<pre class="example">
Running on PyMC v5.0.2
</pre>
</div>
</div>

<div id="outline-container-orgd4a7ec8" class="outline-2">
<h2 id="orgd4a7ec8"><span class="section-number-2">3.</span> Functions</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">inv_logit</span>(p):
    <span class="org-keyword">return</span> 1. / (1. + np.exp(-p))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb838cff" class="outline-2">
<h2 id="orgb838cff"><span class="section-number-2">4.</span> Simulating data</h2>
<div class="outline-text-2" id="text-4">
<p>
Create output directory.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">out_dir</span> = <span class="org-string">"outputs/sim-data-2lv/"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Set seed for repeatability</span>
<span class="org-variable-name">SEED</span> = 1234
<span class="org-variable-name">rng</span> = np.random.default_rng(SEED)

<span class="org-comment-delimiter"># </span><span class="org-comment">Number of sites and species</span>
<span class="org-variable-name">n_sites</span> = 100
<span class="org-variable-name">n_species</span> = 30
<span class="org-comment-delimiter"># </span><span class="org-comment">Number of explanatory variables (including intercept)</span>
<span class="org-variable-name">n_p</span> = 2
<span class="org-comment-delimiter"># </span><span class="org-comment">Number of latent variables</span>
<span class="org-variable-name">n_q</span> = 2

<span class="org-comment-delimiter"># </span><span class="org-comment">Ecological variables</span>
<span class="org-variable-name">Int</span> = np.array([1] * n_sites)
<span class="org-variable-name">x</span> = rng.normal(0, 1, size=n_sites * (n_p - 1))
X = np.concatenate((Int, x)).reshape(n_sites, n_p, order=<span class="org-string">"F"</span>)
<span class="org-builtin">print</span>(<span class="org-string">"X.shape:"</span>)
<span class="org-builtin">print</span>(X.shape)
<span class="org-builtin">print</span>(<span class="org-string">"\nX[:5,]:"</span>)
<span class="org-builtin">print</span>(X[:5,])
<span class="org-comment-delimiter"># </span><span class="org-comment">Number of explicative variables</span>
n_p = X.shape[1]

<span class="org-comment-delimiter"># </span><span class="org-comment">Latent variables</span>
w = rng.normal(0, 1, size=n_sites * n_q)
W_target = w.reshape(n_sites, n_q)
<span class="org-builtin">print</span>(<span class="org-string">"\nW.target.shape:"</span>)
<span class="org-builtin">print</span>(W_target.shape)
<span class="org-builtin">print</span>(<span class="org-string">"\nW_target[:5,]:"</span>)
<span class="org-builtin">print</span>(W_target[:5,])
<span class="org-comment-delimiter"># </span><span class="org-comment">(Check that W_target are independant)</span>
R_W = np.corrcoef(W_target, rowvar=<span class="org-constant">False</span>)
<span class="org-builtin">print</span>(<span class="org-string">"\nR_W:"</span>)
<span class="org-builtin">print</span>(R_W)

<span class="org-comment-delimiter"># </span><span class="org-comment">Fixed species effects beta</span>
beta_target = rng.uniform(-1, 1, n_p * n_species).reshape(n_species, n_p)

<span class="org-comment-delimiter"># </span><span class="org-comment">Factor loading lambda</span>
lambda_target = rng.uniform(-1, 1, n_q * n_species).reshape(n_species, n_q)
<span class="org-comment-delimiter"># </span><span class="org-comment">Decreasing importance of the latent axis</span>
axis_imp = np.arange(n_q, 0, -1)
<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n_q):
    lambda_target[:, i] = lambda_target[:, i] * axis_imp[i]
<span class="org-comment-delimiter"># </span><span class="org-comment">Constraints on lambda</span>
<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n_q):
    lambda_target[i, (i + 1):] = 0
<span class="org-comment-delimiter"># </span><span class="org-comment">Small negative values on diagonal</span>
lambda_target[np.arange(n_q), np.arange(n_q)] = np.array([-0.1] * n_q)
<span class="org-comment-delimiter"># </span><span class="org-comment">Large positive values for following species</span>
<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(n_q):
    lambda_target[n_q + i, i] = n_q - i
    lambda_target[n_q + i, (i + 1):] = 0
<span class="org-builtin">print</span>(<span class="org-string">"\nlambda_target.shape:"</span>)
<span class="org-builtin">print</span>(lambda_target.shape)
<span class="org-builtin">print</span>(<span class="org-string">"\nlambda_target[:6,]:"</span>)
<span class="org-builtin">print</span>(lambda_target[:6,])

<span class="org-comment-delimiter"># </span><span class="org-comment">Variance of random site effects </span>
sigma_alpha_target = 0.5
<span class="org-comment-delimiter"># </span><span class="org-comment">Random site effects</span>
alpha_target = rng.normal(loc=0, scale=sigma_alpha_target, size=n_sites)

<span class="org-comment-delimiter"># </span><span class="org-comment">Probabilities</span>
Xbeta_target = np.matmul(X, beta_target.transpose())
Wlambda_target = np.matmul(W_target, lambda_target.transpose()) 
logit_theta_target = alpha_target[:, np.newaxis] + Xbeta_target + Wlambda_target
theta_target = inv_logit(logit_theta_target)

<span class="org-comment-delimiter"># </span><span class="org-comment">Simulated occurrences</span>
Y = rng.binomial(n=1, p=theta_target)
<span class="org-builtin">print</span>(<span class="org-string">"\nY.shape:"</span>)
<span class="org-builtin">print</span>(Y.shape)

<span class="org-comment-delimiter"># </span><span class="org-comment">Save data-set</span>
<span class="org-keyword">with</span> <span class="org-builtin">open</span>(out_dir + <span class="org-string">"data.pkl"</span>, <span class="org-string">"wb"</span>) <span class="org-keyword">as</span> f:
    data_dump = cloudpickle.dumps({<span class="org-string">"Y"</span>: Y, <span class="org-string">"X"</span>: X})
    f.write(data_dump)
</pre>
</div>

<pre class="example" id="org4e00eb3">
X.shape:
(100, 2)

X[:5,]:
[[ 1.         -1.60383681]
 [ 1.          0.06409991]
 [ 1.          0.7408913 ]
 [ 1.          0.15261919]
 [ 1.          0.86374389]]

W.target.shape:
(100, 2)

W_target[:5,]:
[[ 2.25392546  0.1616142 ]
 [ 0.83377881 -1.58010947]
 [ 1.01058529  0.72186786]
 [-0.58363204  0.68284538]
 [ 0.50536578  1.00145778]]

R_W:
[[1.        0.0422377]
 [0.0422377 1.       ]]

lambda_target.shape:
(30, 2)

lambda_target[:6,]:
[[-0.1         0.        ]
 [-0.96376217 -0.1       ]
 [ 2.          0.        ]
 [-1.71765991  1.        ]
 [ 0.07843035 -0.83177571]
 [-0.50342304  0.46545259]]

Y.shape:
(100, 30)
</pre>

<p>
Histogram of Wlambda.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = os.path.join(out_dir, <span class="org-string">"hist_Wlambda.png"</span>)
<span class="org-variable-name">fig</span> = plt.figure()
plt.hist(Wlambda_target.flatten(), bins=20)
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="org708e2c0">
<img src="outputs/sim-data-2lv/hist_Wlambda.png" alt="hist_Wlambda.png" width="600">

</figure>
</div>
</div>

<div id="outline-container-org73641b9" class="outline-2">
<h2 id="org73641b9"><span class="section-number-2">5.</span> Model</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">HALFNORMAL_SCALE</span> = 1. / np.sqrt(1. - 2. / np.pi)
</pre>
</div>

<p>
We create a function to expand a packed block triangular matrix. Triangular matrices can be stored with better space efficiency by storing the non-zero values in a one-dimensional array. This function is an adaptation of <code>pm.expand.packed.triangular</code>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">expand_packed_block_triangular</span>(n_species, n_q, packed, diag=<span class="org-constant">None</span>, mtype=<span class="org-string">"pytensor"</span>):
    <span class="org-comment-delimiter"># </span><span class="org-comment">like pm.expand_packed_triangular, but with n_species &gt; n_q.</span>
    <span class="org-keyword">assert</span> mtype <span class="org-keyword">in</span> {<span class="org-string">"pytensor"</span>, <span class="org-string">"numpy"</span>}
    <span class="org-keyword">assert</span> n_species &gt;= n_q

    <span class="org-keyword">def</span> <span class="org-function-name">set_</span>(M, i_, v_):
        <span class="org-keyword">if</span> mtype == <span class="org-string">"pytensor"</span>:
            <span class="org-keyword">return</span> pt.set_subtensor(M[i_], v_)
        M[<span class="org-variable-name">i_</span>] = v_
        <span class="org-keyword">return</span> M

    out = pt.zeros((n_species, n_q), dtype=<span class="org-builtin">float</span>) <span class="org-keyword">if</span> mtype == <span class="org-string">"pytensor"</span> <span class="org-keyword">else</span> np.zeros((n_species, n_q), dtype=<span class="org-builtin">float</span>)
    <span class="org-keyword">if</span> diag <span class="org-keyword">is</span> <span class="org-constant">None</span>:
        idxs = np.tril_indices(n_species, m=n_q)
        out = set_(out, idxs, packed)
    <span class="org-keyword">else</span>:
        idxs = np.tril_indices(n_species, k=-1, m=n_q)
        out = set_(out, idxs, packed)
        idxs = (np.arange(n_q), np.arange(n_q))
        out = set_(out, idxs, diag)
    <span class="org-keyword">return</span> out
</pre>
</div>

<p>
We define another function which creates a diagonal matrix with positive values on the diagonal.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">makeLambda</span>(n_species, n_q, dim_names):
    <span class="org-comment-delimiter"># </span><span class="org-comment">Number of non-zeros factor loadings</span>
    <span class="org-variable-name">n_L_packed</span> = <span class="org-builtin">int</span>(n_species * n_q - n_q * (n_q - 1) / 2 - n_q)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Diagonal matrix</span>
    <span class="org-variable-name">L_diag</span> = pm.HalfNormal(<span class="org-string">"L_diag"</span>, sigma=HALFNORMAL_SCALE*np.sqrt(10), shape=n_q)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Packed Lambda</span>
    L_packed = pm.Normal(<span class="org-string">"L_packed"</span>, mu=0, sigma=np.sqrt(10), shape=n_L_packed)
    L = expand_packed_block_triangular(n_species, n_q, L_packed, diag=L_diag)
    Lambda = pm.Deterministic(<span class="org-string">"Lambda"</span>, L, dims=dim_names)
    <span class="org-keyword">return</span> Lambda
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> pm.Model() <span class="org-keyword">as</span> <span class="org-variable-name">model</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Hyperpriors</span>
    sigma_alpha = pm.HalfNormal(<span class="org-string">"sigma_alpha"</span>, sigma=1.0)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Priors</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Site random effect</span>
    alpha = pm.Normal(<span class="org-string">"alpha"</span>, mu=0, sigma=sigma_alpha, shape=n_sites, dims=<span class="org-string">"sites"</span>)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Latent variables</span>
    W = pm.Normal(<span class="org-string">"W"</span>, mu=0, sigma=1, shape=(n_sites, n_q), dims=(<span class="org-string">"sites"</span>, <span class="org-string">"latent_axis"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Species effects</span>
    beta = pm.Normal(<span class="org-string">"beta"</span>, mu=0, sigma=1, shape=(n_species, n_p), dims=(<span class="org-string">"species"</span>, <span class="org-string">"fixed_effects"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Factor loadings with constraints</span>
    Lambda = makeLambda(n_species, n_q, (<span class="org-string">"species"</span>, <span class="org-string">"latent_axis"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Likelihood</span>
    Xbeta = pm.math.dot(X, beta.transpose())
    Wlambda = pm.math.dot(W, Lambda.transpose()) 
    logit_theta = alpha[:, np.newaxis] + Xbeta + Wlambda
    obs = pm.Bernoulli(<span class="org-string">"obs"</span>, logit_p=logit_theta, observed=Y)
</pre>
</div>

<p>
Parameters for MCMC sampling:
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">CORES</span> = 2
<span class="org-variable-name">SAMPLE_KWARGS</span> = {
    <span class="org-string">'draws'</span>: 1000,
    <span class="org-string">'cores'</span>: CORES,
    <span class="org-string">'init'</span>: <span class="org-string">'auto'</span>,
    <span class="org-string">'tune'</span>: 1000,
    <span class="org-string">'random_seed'</span>: [SEED + i <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(CORES)]
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Inference</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model</span>:
    trace = pm.sample(**SAMPLE_KWARGS)
</pre>
</div>

<p>
Save model with cloudpickle (cf. <a href="https://github.com/pymc-devs/pymc/issues/5886">link</a>).
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-builtin">open</span>(out_dir + <span class="org-string">"model_trace.pkl"</span>, <span class="org-string">"wb"</span>) <span class="org-keyword">as</span> <span class="org-variable-name">f</span>:
     model_trace_dump = cloudpickle.dumps({<span class="org-string">'model'</span>: model, <span class="org-string">'trace'</span>: trace})
     f.write(model_trace_dump)
</pre>
</div>

<p>
Then, model results can be loaded with the following code:
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">f</span> = <span class="org-builtin">open</span>(out_dir + <span class="org-string">"model_trace.pkl"</span>, <span class="org-string">"rb"</span>)
<span class="org-variable-name">model_trace</span> = cloudpickle.loads(f.read())
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a33115" class="outline-2">
<h2 id="org0a33115"><span class="section-number-2">6.</span> Convergence and model performance</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org49f2b63" class="outline-3">
<h3 id="org49f2b63"><span class="section-number-3">6.1.</span> Plotting traces</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = out_dir + <span class="org-string">"trace.png"</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model</span>:
    axes = az.plot_trace(trace,
                         var_names=[<span class="org-string">"alpha"</span>, <span class="org-string">"beta"</span>,
                                    <span class="org-string">"sigma_alpha"</span>])
fig = axes.ravel()[0].figure
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="org2df7671">
<img src="outputs/sim-data-2lv/trace.png" alt="trace.png" width="900">

</figure>
</div>
</div>

<div id="outline-container-org4ee1fb5" class="outline-3">
<h3 id="org4ee1fb5"><span class="section-number-3">6.2.</span> Parameter estimates.</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-variable-name">model</span>:
    summary = az.summary(trace,
                         var_names=[<span class="org-string">"alpha"</span>, <span class="org-string">"beta"</span>,
                                    <span class="org-string">"sigma_alpha"</span>], round_to=2)
summary.to_csv(out_dir + <span class="org-string">"model_summary.txt"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-variable-name">model</span>:
    alpha_est = az.summary(trace, var_names=[<span class="org-string">"alpha"</span>], round_to=2)
    beta_est = az.summary(trace, var_names=[<span class="org-string">"beta"</span>], round_to=2)
    lambda_est = az.summary(trace, var_names=[<span class="org-string">"Lambda"</span>], round_to=2)
    lambda_0_est = az.summary(trace,
                              var_names=[<span class="org-string">"Lambda"</span>],
                              coords={<span class="org-string">"latent_axis"</span>: [0]},
                              round_to=2)
    lambda_1_est = az.summary(trace,
                              var_names=[<span class="org-string">"Lambda"</span>],
                              coords={<span class="org-string">"latent_axis"</span>: [1]},
                              round_to=2)
    W_est = az.summary(trace, var_names=[<span class="org-string">"W"</span>], round_to=2)
    W_0_est = az.summary(trace, var_names=[<span class="org-string">"W"</span>],
                         coords={<span class="org-string">"latent_axis"</span>: [0]},
                         round_to=2)
    W_1_est = az.summary(trace, var_names=[<span class="org-string">"W"</span>],
                         coords={<span class="org-string">"latent_axis"</span>: [1]},
                         round_to=2)
</pre>
</div>
</div>
</div>

<div id="outline-container-org134d7ad" class="outline-3">
<h3 id="org134d7ad"><span class="section-number-3">6.3.</span> Traces for constrained parameters</h3>
<div class="outline-text-3" id="text-6-3">
</div>
<div id="outline-container-orgcaccb06" class="outline-4">
<h4 id="orgcaccb06"><span class="section-number-4">6.3.1.</span> Factor loadings on the diagonal</h4>
<div class="outline-text-4" id="text-6-3-1">
<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = out_dir + <span class="org-string">"trace_lambda_00.png"</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model</span>:
    axes = az.plot_trace(trace,
                         var_names=[<span class="org-string">"Lambda"</span>],
                         coords={<span class="org-string">"species"</span>: [0],
                                 <span class="org-string">"latent_axis"</span>: [0]})
fig = axes.ravel()[0].figure
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="orgaeddce4">
<img src="outputs/sim-data-2lv/trace_lambda_00.png" alt="trace_lambda_00.png" width="750">

</figure>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = out_dir + <span class="org-string">"trace_lambda_11.png"</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model</span>:
    axes = az.plot_trace(trace,
                         var_names=[<span class="org-string">"Lambda"</span>],
                         coords={<span class="org-string">"species"</span>: [1],
                                 <span class="org-string">"latent_axis"</span>: [1]})
fig = axes.ravel()[0].figure
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="org21e5ccd">
<img src="outputs/sim-data-2lv/trace_lambda_11.png" alt="trace_lambda_11.png" width="750">

</figure>

<p>
For these two lambdas, the MCMCs do not converge and samples are concentrated around the zero values, the closest positive value to the target values of -0.1.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">lambda_diag</span> = lambda_est.loc[[<span class="org-string">"Lambda[0, 0]"</span>, <span class="org-string">"Lambda[1, 1]"</span>], [<span class="org-string">"mean"</span>, <span class="org-string">"sd"</span>, <span class="org-string">"r_hat"</span>]]
<span class="org-variable-name">lambda_diag</span>[<span class="org-string">"target_value"</span>] = [lambda_target[0, 0], lambda_target[1, 1]]
tabulate(lambda_diag, headers=<span class="org-string">"keys"</span>, tablefmt=<span class="org-string">"orgtbl"</span>, showindex=<span class="org-constant">True</span>)
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-right">mean</th>
<th scope="col" class="org-right">sd</th>
<th scope="col" class="org-right">r_hat</th>
<th scope="col" class="org-right">target_value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Lambda[0, 0]</td>
<td class="org-right">0.76</td>
<td class="org-right">0.42</td>
<td class="org-right">1.05</td>
<td class="org-right">-0.1</td>
</tr>

<tr>
<td class="org-left">Lambda[1, 1]</td>
<td class="org-right">1.07</td>
<td class="org-right">0.47</td>
<td class="org-right">1.1</td>
<td class="org-right">-0.1</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgdf7327c" class="outline-4">
<h4 id="orgdf7327c"><span class="section-number-4">6.3.2.</span> Species with high factor loadings</h4>
<div class="outline-text-4" id="text-6-3-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = out_dir + <span class="org-string">"trace_lambda_20.png"</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model</span>:
    axes = az.plot_trace(trace,
                         var_names=[<span class="org-string">"Lambda"</span>],
                         coords={<span class="org-string">"species"</span>: [2],
                                 <span class="org-string">"latent_axis"</span>: [0]})
fig = axes.ravel()[0].figure
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="org2cfb209">
<img src="outputs/sim-data-2lv/trace_lambda_20.png" alt="trace_lambda_20.png" width="750">

</figure>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = out_dir + <span class="org-string">"trace_lambda_31.png"</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model</span>:
    axes = az.plot_trace(trace,
                         var_names=[<span class="org-string">"Lambda"</span>],
                         coords={<span class="org-string">"species"</span>: [3],
                                 <span class="org-string">"latent_axis"</span>: [1]})
fig = axes.ravel()[0].figure
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="orgcc8322d">
<img src="outputs/sim-data-2lv/trace_lambda_31.png" alt="trace_lambda_31.png" width="750">

</figure>

<p>
For species with high factor loadings, the MCMCs do not converge (r_hat &gt;&gt; 1) and oscillate between positive and negative values (bimodal distributions) because the sign of the factor loadings are not correctly set by the constraints on the diagonal. The mean parameter estimates end up being close to zero while the target parameter values are far from zero (values 2 and -2).
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">lambda_high</span> = lambda_est.loc[[<span class="org-string">"Lambda[2, 0]"</span>, <span class="org-string">"Lambda[3, 1]"</span>], [<span class="org-string">"mean"</span>, <span class="org-string">"sd"</span>, <span class="org-string">"r_hat"</span>]]
<span class="org-variable-name">lambda_high</span>[<span class="org-string">"target_value"</span>] = [lambda_target[2, 0], lambda_target[3, 1]]
tabulate(lambda_high, headers=<span class="org-string">"keys"</span>, tablefmt=<span class="org-string">"orgtbl"</span>, showindex=<span class="org-constant">True</span>)
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-right">mean</th>
<th scope="col" class="org-right">sd</th>
<th scope="col" class="org-right">r_hat</th>
<th scope="col" class="org-right">target_value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Lambda[2, 0]</td>
<td class="org-right">-0.28</td>
<td class="org-right">1.06</td>
<td class="org-right">1.38</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">Lambda[3, 1]</td>
<td class="org-right">1.54</td>
<td class="org-right">1.21</td>
<td class="org-right">1.34</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org1dcc0a8" class="outline-3">
<h3 id="org1dcc0a8"><span class="section-number-3">6.4.</span> Convergence criteria</h3>
<div class="outline-text-3" id="text-6-4">
<p>
We compute the mean r_hat for each category of parameters.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Compute r_hat mean and std</span>
<span class="org-variable-name">rhat_alpha_mean</span> = <span class="org-builtin">round</span>(alpha_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_alpha_std</span> = <span class="org-builtin">round</span>(alpha_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_beta_mean</span> = <span class="org-builtin">round</span>(beta_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_beta_std</span> = <span class="org-builtin">round</span>(beta_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_W_mean</span> = <span class="org-builtin">round</span>(W_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_W_std</span> = <span class="org-builtin">round</span>(W_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_mean</span> = <span class="org-builtin">round</span>(lambda_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_std</span> = <span class="org-builtin">round</span>(lambda_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_diag_mean</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[0, 0]"</span>, <span class="org-string">"Lambda[1, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_diag_std</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[0, 0]"</span>, <span class="org-string">"Lambda[1, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_high_mean</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[2, 0]"</span>, <span class="org-string">"Lambda[3, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_high_std</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[2, 0]"</span>, <span class="org-string">"Lambda[3, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].std(), 2)

<span class="org-comment-delimiter"># </span><span class="org-comment">Build dataframe</span>
<span class="org-variable-name">par_names</span> = [<span class="org-string">"alpha"</span>, <span class="org-string">"beta"</span>, <span class="org-string">"W"</span>, <span class="org-string">"lambda"</span>, <span class="org-string">"lambda_diag"</span>, <span class="org-string">"lambda_high"</span>]
<span class="org-variable-name">mean_val</span> = [<span class="org-builtin">eval</span>(<span class="org-string">"rhat_"</span> + x + <span class="org-string">"_mean"</span>) <span class="org-keyword">for</span> x <span class="org-keyword">in</span> par_names]
<span class="org-variable-name">std_val</span> = [<span class="org-builtin">eval</span>(<span class="org-string">"rhat_"</span> + x + <span class="org-string">"_std"</span>) <span class="org-keyword">for</span> x <span class="org-keyword">in</span> par_names]

<span class="org-variable-name">rhat_dic</span> = {<span class="org-string">"par"</span>: par_names,
            <span class="org-string">"r_hat_mean"</span>: mean_val, <span class="org-string">"rhat_std"</span>: std_val}
<span class="org-variable-name">rhat_df</span> = pd.DataFrame(rhat_dic)
tabulate(rhat_df, headers=<span class="org-string">"keys"</span>, tablefmt=<span class="org-string">"orgtbl"</span>, showindex=<span class="org-constant">False</span>)
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">par</th>
<th scope="col" class="org-right">r_hat_mean</th>
<th scope="col" class="org-right">rhat_std</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">alpha</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">beta</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">W</td>
<td class="org-right">1.12</td>
<td class="org-right">0.09</td>
</tr>

<tr>
<td class="org-left">lambda</td>
<td class="org-right">1.21</td>
<td class="org-right">0.12</td>
</tr>

<tr>
<td class="org-left">lambda_diag</td>
<td class="org-right">1.08</td>
<td class="org-right">0.04</td>
</tr>

<tr>
<td class="org-left">lambda_high</td>
<td class="org-right">1.36</td>
<td class="org-right">0.03</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org696fda3" class="outline-3">
<h3 id="org696fda3"><span class="section-number-3">6.5.</span> Predicted vs. target parameter values</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">alpha</span>
<span class="org-variable-name">f</span> = out_dir + <span class="org-string">"alpha.png"</span>
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(figsize=(6, 6))
ax.scatter(alpha_target, alpha_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"alpha"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">beta</span>
f = out_dir + <span class="org-string">"beta.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(beta_target.flatten(), beta_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"beta"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_0</span>
f = out_dir + <span class="org-string">"W_0.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(W_target[:, 0], W_0_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_0"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_1</span>
f = out_dir + <span class="org-string">"W_1.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(W_target[:, 1], W_1_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_1"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">lambda_0</span>
f = out_dir + <span class="org-string">"lambda_0.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(lambda_target[:, 0], lambda_0_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"lambda_0"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">lambda_1</span>
f = out_dir + <span class="org-string">"lambda_1.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(lambda_target[:, 1], lambda_1_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"lambda_1"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_lambda</span>
W_lambda_est = np.matmul(
    np.asarray(W_est[<span class="org-string">"mean"</span>]).reshape(n_sites, n_q),
    np.asarray(lambda_est[<span class="org-string">"mean"</span>]).reshape(n_species, n_q).transpose())
f = out_dir + <span class="org-string">"W_lambda.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(Wlambda_target.flatten(), W_lambda_est.flatten(), c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_lambda"</span>)
fig.savefig(f)
</pre>
</div>


<figure id="org3e2dc70">
<img src="outputs/sim-data-2lv/W_0.png" alt="W_0.png" width="375">

</figure>


<figure id="org0207060">
<img src="outputs/sim-data-2lv/W_1.png" alt="W_1.png" width="375">

</figure>


<figure id="orgd2025b8">
<img src="outputs/sim-data-2lv/lambda_0.png" alt="lambda_0.png" width="375">

</figure>


<figure id="org51d7b1b">
<img src="outputs/sim-data-2lv/lambda_1.png" alt="lambda_1.png" width="375">

</figure>


<figure id="orgc9c6249">
<img src="outputs/sim-data-2lv/W_lambda.png" alt="W_lambda.png" width="375">

</figure>
</div>
</div>
</div>

<div id="outline-container-org8960fa0" class="outline-2">
<h2 id="org8960fa0"><span class="section-number-2">7.</span> Correcting for species order</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org6d113de" class="outline-3">
<h3 id="org6d113de"><span class="section-number-3">7.1.</span> Sorting species</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Species with high factor values are used for constraints.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">Y_sort</span> = np.copy(Y)
<span class="org-variable-name">Y_sort</span>[:, 0] = Y[:, 2]
<span class="org-variable-name">Y_sort</span>[:, 1] = Y[:, 3]
<span class="org-variable-name">Y_sort</span>[:, 2] = Y[:, 0]
<span class="org-variable-name">Y_sort</span>[:, 3] = Y[:, 1]
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d98440" class="outline-3">
<h3 id="org7d98440"><span class="section-number-3">7.2.</span> Statistical model</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> pm.Model() <span class="org-keyword">as</span> <span class="org-variable-name">model_sort</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Hyperpriors</span>
    sigma_alpha = pm.HalfNormal(<span class="org-string">"sigma_alpha"</span>, sigma=1.0)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Priors</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Site random effect</span>
    alpha = pm.Normal(<span class="org-string">"alpha"</span>, mu=0, sigma=sigma_alpha, shape=n_sites, dims=<span class="org-string">"sites"</span>)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Latent variables</span>
    W = pm.Normal(<span class="org-string">"W"</span>, mu=0, sigma=1, shape=(n_sites, n_q), dims=(<span class="org-string">"sites"</span>, <span class="org-string">"latent_axis"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Species effects</span>
    beta = pm.Normal(<span class="org-string">"beta"</span>, mu=0, sigma=1, shape=(n_species, n_p), dims=(<span class="org-string">"species"</span>, <span class="org-string">"fixed_effects"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Factor loadings with constraints</span>
    Lambda = makeLambda(n_species, n_q, (<span class="org-string">"species"</span>, <span class="org-string">"latent_axis"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Likelihood</span>
    Xbeta = pm.math.dot(X, beta.transpose())
    Wlambda = pm.math.dot(W, Lambda.transpose()) 
    logit_theta = alpha[:, np.newaxis] + Xbeta + Wlambda
    obs = pm.Bernoulli(<span class="org-string">"obs"</span>, logit_p=logit_theta, observed=Y_sort)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Inference</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model_sort</span>:
    trace_sort = pm.sample(**SAMPLE_KWARGS)
</pre>
</div>

<p>
Save model with cloudpickle.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-builtin">open</span>(out_dir + <span class="org-string">"model_trace_sort.pkl"</span>, <span class="org-string">"wb"</span>) <span class="org-keyword">as</span> <span class="org-variable-name">f</span>:
     model_trace_dump = cloudpickle.dumps({<span class="org-string">'model'</span>: model_sort, <span class="org-string">'trace'</span>: trace_sort})
     f.write(model_trace_dump)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f2b777" class="outline-3">
<h3 id="org3f2b777"><span class="section-number-3">7.3.</span> Convergence and model performance</h3>
<div class="outline-text-3" id="text-7-3">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-variable-name">model_sort</span>:
    alpha_est = az.summary(trace_sort, var_names=[<span class="org-string">"alpha"</span>], round_to=2)
    beta_est = az.summary(trace_sort, var_names=[<span class="org-string">"beta"</span>], round_to=2)
    lambda_est = az.summary(trace_sort, var_names=[<span class="org-string">"Lambda"</span>], round_to=2)
    lambda_0_est = az.summary(trace_sort,
                              var_names=[<span class="org-string">"Lambda"</span>],
                              coords={<span class="org-string">"latent_axis"</span>: [0]},
                              round_to=2)
    lambda_1_est = az.summary(trace_sort,
                              var_names=[<span class="org-string">"Lambda"</span>],
                              coords={<span class="org-string">"latent_axis"</span>: [1]},
                              round_to=2)
    W_est = az.summary(trace_sort, var_names=[<span class="org-string">"W"</span>], round_to=2)
    W_0_est = az.summary(trace_sort, var_names=[<span class="org-string">"W"</span>],
                         coords={<span class="org-string">"latent_axis"</span>: [0]},
                         round_to=2)
    W_1_est = az.summary(trace_sort, var_names=[<span class="org-string">"W"</span>],
                         coords={<span class="org-string">"latent_axis"</span>: [1]},
                         round_to=2)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">lambda_diag</span> = lambda_est.loc[[<span class="org-string">"Lambda[0, 0]"</span>, <span class="org-string">"Lambda[1, 1]"</span>], [<span class="org-string">"mean"</span>, <span class="org-string">"sd"</span>, <span class="org-string">"r_hat"</span>]]
<span class="org-variable-name">lambda_diag</span>[<span class="org-string">"target_value"</span>] = [lambda_target[2, 0], lambda_target[3, 1]]
<span class="org-variable-name">col_names</span> = [<span class="org-string">"Distance"</span>, <span class="org-string">"Npixels"</span>, <span class="org-string">"Area"</span>, <span class="org-string">"Cumulation"</span>, <span class="org-string">"Percentage"</span>]
tabulate(lambda_diag, headers=<span class="org-string">"keys"</span>, tablefmt=<span class="org-string">"orgtbl"</span>, showindex=<span class="org-constant">True</span>)
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-right">mean</th>
<th scope="col" class="org-right">sd</th>
<th scope="col" class="org-right">r_hat</th>
<th scope="col" class="org-right">target_value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Lambda[0, 0]</td>
<td class="org-right">1.67</td>
<td class="org-right">0.49</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">Lambda[1, 1]</td>
<td class="org-right">0.2</td>
<td class="org-right">0.19</td>
<td class="org-right">1.01</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Compute r_hat mean and std</span>
<span class="org-variable-name">rhat_alpha_mean</span> = <span class="org-builtin">round</span>(alpha_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_alpha_std</span> = <span class="org-builtin">round</span>(alpha_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_beta_mean</span> = <span class="org-builtin">round</span>(beta_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_beta_std</span> = <span class="org-builtin">round</span>(beta_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_W_mean</span> = <span class="org-builtin">round</span>(W_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_W_std</span> = <span class="org-builtin">round</span>(W_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_mean</span> = <span class="org-builtin">round</span>(lambda_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_std</span> = <span class="org-builtin">round</span>(lambda_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_diag_mean</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[0, 0]"</span>, <span class="org-string">"Lambda[1, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_diag_std</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[0, 0]"</span>, <span class="org-string">"Lambda[1, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_small_mean</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[2, 0]"</span>, <span class="org-string">"Lambda[3, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_small_std</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[2, 0]"</span>, <span class="org-string">"Lambda[3, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].std(), 2)

<span class="org-comment-delimiter"># </span><span class="org-comment">Build dataframe</span>
<span class="org-variable-name">par_names</span> = [<span class="org-string">"alpha"</span>, <span class="org-string">"beta"</span>, <span class="org-string">"W"</span>, <span class="org-string">"lambda"</span>, <span class="org-string">"lambda_diag"</span>, <span class="org-string">"lambda_small"</span>]
<span class="org-variable-name">mean_val</span> = [<span class="org-builtin">eval</span>(<span class="org-string">"rhat_"</span> + x + <span class="org-string">"_mean"</span>) <span class="org-keyword">for</span> x <span class="org-keyword">in</span> par_names]
<span class="org-variable-name">std_val</span> = [<span class="org-builtin">eval</span>(<span class="org-string">"rhat_"</span> + x + <span class="org-string">"_std"</span>) <span class="org-keyword">for</span> x <span class="org-keyword">in</span> par_names]

<span class="org-variable-name">rhat_dic</span> = {<span class="org-string">"par"</span>: par_names,
            <span class="org-string">"r_hat_mean"</span>: mean_val, <span class="org-string">"rhat_std"</span>: std_val}
<span class="org-variable-name">rhat_df</span> = pd.DataFrame(rhat_dic)
tabulate(rhat_df, headers=<span class="org-string">"keys"</span>, tablefmt=<span class="org-string">"orgtbl"</span>, showindex=<span class="org-constant">False</span>)
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">par</th>
<th scope="col" class="org-right">r_hat_mean</th>
<th scope="col" class="org-right">rhat_std</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">alpha</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">beta</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">W</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">lambda</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">lambda_diag</td>
<td class="org-right">1</td>
<td class="org-right">0.01</td>
</tr>

<tr>
<td class="org-left">lambda_small</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org284988e" class="outline-3">
<h3 id="org284988e"><span class="section-number-3">7.4.</span> Predicted vs. target parameter values</h3>
<div class="outline-text-3" id="text-7-4">
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Sorted index</span>
<span class="org-builtin">id</span> = [2, 3, 0, 1] + <span class="org-builtin">list</span>(np.arange(4, n_species))

<span class="org-comment-delimiter"># </span><span class="org-comment">alpha</span>
<span class="org-variable-name">f</span> = out_dir + <span class="org-string">"alpha_sort.png"</span>
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(figsize=(6, 6))
ax.scatter(alpha_target, alpha_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"alpha_sort"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">beta</span>
f = out_dir + <span class="org-string">"beta_sort.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
beta_hat = np.asarray(beta_est[<span class="org-string">"mean"</span>]).reshape(n_species, n_p)[<span class="org-builtin">id</span>, :]
ax.scatter(beta_target.flatten(), beta_hat.flatten(), c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"beta_sort"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_0</span>
f = out_dir + <span class="org-string">"W_0_sort.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(W_target[:, 0], W_0_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_0_sort"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_1</span>
f = out_dir + <span class="org-string">"W_1_sort.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(W_target[:, 1], W_1_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_1_sort"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">lambda_0</span>
f = out_dir + <span class="org-string">"lambda_0_sort.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
lambda_0_hat = lambda_0_est[<span class="org-string">"mean"</span>][<span class="org-builtin">id</span>]
ax.scatter(lambda_target[:, 0], lambda_0_hat, c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"lambda_0_sort"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">lambda_1</span>
f = out_dir + <span class="org-string">"lambda_1_sort.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
lambda_1_hat = lambda_1_est[<span class="org-string">"mean"</span>][<span class="org-builtin">id</span>]
ax.scatter(lambda_target[:, 1], lambda_1_hat, c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"lambda_1_sort"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_lambda</span>
lambda_hat = np.asarray(lambda_est[<span class="org-string">"mean"</span>]).reshape(n_species, n_q)[<span class="org-builtin">id</span>, :]
W_lambda_est = np.matmul(
    np.asarray(W_est[<span class="org-string">"mean"</span>]).reshape(n_sites, n_q),
    lambda_hat.transpose())
f = out_dir + <span class="org-string">"W_lambda_sort.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(Wlambda_target.flatten(), W_lambda_est.flatten(), c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_lambda_sort"</span>)
fig.savefig(f)
</pre>
</div>


<figure id="orgde83570">
<img src="outputs/sim-data-2lv/W_0.png" alt="W_0.png" width="375" style="float:left;">

</figure>


<figure id="orgf91cc38">
<img src="outputs/sim-data-2lv/W_0_sort.png" alt="W_0_sort.png" width="375">

</figure>


<figure id="org624cb06">
<img src="outputs/sim-data-2lv/W_1.png" alt="W_1.png" width="375" style="float:left;">

</figure>


<figure id="org7485ae5">
<img src="outputs/sim-data-2lv/W_1_sort.png" alt="W_1_sort.png" width="375">

</figure>


<figure id="orgdc5af32">
<img src="outputs/sim-data-2lv/lambda_0.png" alt="lambda_0.png" width="375" style="float:left;">

</figure>


<figure id="org5ca4a60">
<img src="outputs/sim-data-2lv/lambda_0_sort.png" alt="lambda_0_sort.png" width="375">

</figure>


<figure id="org50374e6">
<img src="outputs/sim-data-2lv/lambda_1.png" alt="lambda_1.png" width="375" style="float:left;">

</figure>


<figure id="orgecfc76a">
<img src="outputs/sim-data-2lv/lambda_1_sort.png" alt="lambda_1_sort.png" width="375">

</figure>


<figure id="org4351fe3">
<img src="outputs/sim-data-2lv/W_lambda.png" alt="W_lambda.png" width="375" style="float:left;">

</figure>


<figure id="org9915e30">
<img src="outputs/sim-data-2lv/W_lambda_sort.png" alt="W_lambda_sort.png" width="375">

</figure>
</div>
</div>
</div>

<div id="outline-container-org861894b" class="outline-2">
<h2 id="org861894b"><span class="section-number-2">8.</span> Automatic sorting of species with PCAÂ on residuals</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-orgdbc8081" class="outline-3">
<h3 id="orgdbc8081"><span class="section-number-3">8.1.</span> Unsorted data</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">f</span> = <span class="org-builtin">open</span>(out_dir + <span class="org-string">"data.pkl"</span>, <span class="org-string">"rb"</span>)
<span class="org-variable-name">data</span> = cloudpickle.loads(f.read())
<span class="org-variable-name">Y</span> = data[<span class="org-string">"Y"</span>]
<span class="org-variable-name">X</span> = data[<span class="org-string">"X"</span>]
<span class="org-builtin">print</span>(<span class="org-string">"X.shape:"</span>)
<span class="org-builtin">print</span>(X.shape)
<span class="org-builtin">print</span>(<span class="org-string">"\nX[:5,]:"</span>)
<span class="org-builtin">print</span>(X[:5,])
<span class="org-builtin">print</span>(<span class="org-string">"\nY.shape:"</span>)
<span class="org-builtin">print</span>(Y.shape)
</pre>
</div>

<pre class="example" id="org1dfccb9">
X.shape:
(100, 2)

X[:5,]:
[[ 1.         -1.60383681]
 [ 1.          0.06409991]
 [ 1.          0.7408913 ]
 [ 1.          0.15261919]
 [ 1.          0.86374389]]

Y.shape:
(100, 30)
</pre>
</div>
</div>

<div id="outline-container-org4c68651" class="outline-3">
<h3 id="org4c68651"><span class="section-number-3">8.2.</span> Statistical model with residuals</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> pm.Model() <span class="org-keyword">as</span> <span class="org-variable-name">model_res</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Hyperpriors</span>
    sigma_alpha = pm.HalfNormal(<span class="org-string">"sigma_alpha"</span>, sigma=1.0)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Priors</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Site random effect</span>
    alpha = pm.Normal(<span class="org-string">"alpha"</span>, mu=0, sigma=sigma_alpha, shape=n_sites)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Species effects</span>
    beta = pm.Normal(<span class="org-string">"beta"</span>, mu=0, sigma=1, shape=(n_species, n_p))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Likelihood</span>
    Xbeta = pm.math.dot(X, beta.transpose())
    m = pm.Deterministic(<span class="org-string">"mu"</span>, alpha[:, np.newaxis] + Xbeta)
    logit_theta = pm.Normal(<span class="org-string">"logit_theta"</span>, mu=m, sigma=1)
    e = pm.Deterministic(<span class="org-string">"error"</span>, logit_theta - m)
    obs = pm.Bernoulli(<span class="org-string">"obs"</span>, logit_p=logit_theta, observed=Y)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Inference</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model_res</span>:
    trace_res = pm.sample(**SAMPLE_KWARGS)
</pre>
</div>

<p>
Save model with cloudpickle.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-builtin">open</span>(out_dir + <span class="org-string">"model_trace_res.pkl"</span>, <span class="org-string">"wb"</span>) <span class="org-keyword">as</span> <span class="org-variable-name">f</span>:
    model_trace_dump = cloudpickle.dumps({<span class="org-string">'model'</span>: model_res, <span class="org-string">'trace'</span>: trace_res})
    f.write(model_trace_dump)
</pre>
</div>

<p>
Get residuals.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-variable-name">model_res</span>:
    error_est = az.summary(trace_res, var_names=[<span class="org-string">"error"</span>], round_to=2)
e = np.asarray(error_est[<span class="org-string">"mean"</span>]).reshape(n_sites, n_species)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = os.path.join(out_dir, <span class="org-string">"hist_residuals.png"</span>)
<span class="org-variable-name">fig</span> = plt.figure()
plt.hist(e.flatten(), bins=20)
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="org150eed6">
<img src="outputs/sim-data-2lv/hist_residuals.png" alt="hist_residuals.png" width="600">

</figure>

<p>
Correlation between residuals and Wlambda.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = out_dir + <span class="org-string">"corr_res_Wlambda.png"</span>
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(figsize=(6, 6))
ax.scatter(Wlambda_target, e, c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_xlabel(<span class="org-string">"Wlambda_target"</span>)
ax.set_ylabel(<span class="org-string">"Estimated residuals"</span>)
ax.set_title(<span class="org-string">"corr_res_Wlambda"</span>)
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="org3b53fe4">
<img src="outputs/sim-data-2lv/corr_res_Wlambda.png" alt="corr_res_Wlambda.png" width="600">

</figure>
</div>
</div>

<div id="outline-container-orgb0683f5" class="outline-3">
<h3 id="orgb0683f5"><span class="section-number-3">8.3.</span> PCA on residuals</h3>
<div class="outline-text-3" id="text-8-3">
<p>
Make the PCA on residuals to find the coordinates of the species on two axis.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">from</span> sklearn.decomposition <span class="org-keyword">import</span> PCA
<span class="org-keyword">from</span> sklearn.preprocessing <span class="org-keyword">import</span> StandardScaler

<span class="org-variable-name">pca</span> = PCA(n_components=2)
e_cr = StandardScaler().fit_transform(e)
pca_features = pca.fit_transform(e_cr)
pca_features.shape
<span class="org-builtin">print</span>(pca.explained_variance_ratio_)
</pre>
</div>

<pre class="example">
[0.21591098 0.08906021]
</pre>


<p>
The first axis explains a higher percentage of the inertia than the second axis.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">pca_comp</span> = pca.components_.transpose()
<span class="org-builtin">print</span>(pca_comp)
</pre>
</div>

<pre class="example" id="orgb271da5">
[[ 0.04692378 -0.21384329]
 [ 0.18100145  0.03470675]
 [-0.22266366 -0.118447  ]
 [ 0.24103108 -0.21171194]
 [ 0.01140621  0.34386345]
 [ 0.04424672 -0.1326954 ]
 [ 0.24147544 -0.10418143]
 [-0.22460682  0.05477689]
 [-0.1001427  -0.20516141]
 [-0.18297192  0.14689355]
 [-0.13958024 -0.26841004]
 [-0.15698748  0.24706136]
 [-0.24997254 -0.30120634]
 [-0.14926731  0.27085541]
 [ 0.15531343  0.00151203]
 [ 0.18676268  0.06231319]
 [-0.26034287 -0.09968252]
 [ 0.20706059 -0.16658225]
 [-0.0437241  -0.20905267]
 [-0.12967744 -0.21507216]
 [ 0.07620406 -0.3192065 ]
 [-0.13761504  0.25479687]
 [ 0.23606282  0.01313387]
 [-0.20617314  0.01725708]
 [ 0.29775449  0.11980329]
 [ 0.13900535 -0.01052118]
 [ 0.19418434  0.09522476]
 [-0.19307443  0.15404952]
 [ 0.12722835 -0.06802791]
 [ 0.25218927  0.18156252]]
</pre>

<p>
Identify the species which influences most each component.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">pca_comp_abs</span> = np.<span class="org-builtin">abs</span>(pca_comp)
<span class="org-variable-name">sp_sel</span> = np.argmax(pca_comp_abs, axis=0)
<span class="org-builtin">print</span>(sp_sel)
</pre>
</div>

<pre class="example">
[24  4]
</pre>


<p>
We correctly identified the two species. We look again at the factor loadings for these two species.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-builtin">print</span>(lambda_target[sp_sel, :])
</pre>
</div>

<pre class="example">
[[-1.92085221 -0.39393461]
 [ 0.07843035 -0.83177571]]
</pre>


<p>
Sorting species.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">Y_auto</span> = np.copy(Y)
<span class="org-variable-name">Y_auto</span>[:, 0] = Y[:, sp_sel[0]]
<span class="org-variable-name">Y_auto</span>[:, 1] = Y[:, sp_sel[1]]
Y_auto[:, sp_sel[0]] = Y[:, 0]
Y_auto[:, sp_sel[1]] = Y[:, 1]
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfda95c2" class="outline-3">
<h3 id="orgfda95c2"><span class="section-number-3">8.4.</span> Correlation between loadings and species coordinates on the PCA axis</h3>
<div class="outline-text-3" id="text-8-4">
<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">cor</span> = np.corrcoef(np.<span class="org-builtin">abs</span>(lambda_target.flatten()), np.<span class="org-builtin">abs</span>(pca_comp.flatten()))
<span class="org-builtin">print</span>(cor)
</pre>
</div>

<pre class="example">
[[1.         0.63155205]
 [0.63155205 1.        ]]
</pre>


<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">ofile</span> = os.path.join(out_dir, <span class="org-string">"cor_lambda_coordPCA_e.png"</span>)
<span class="org-variable-name">fig</span>, <span class="org-variable-name">axs</span> = plt.subplots(2, sharex=<span class="org-constant">True</span>)
axs[0].scatter(np.<span class="org-builtin">abs</span>(lambda_target[:, 0]), np.<span class="org-builtin">abs</span>(pca_comp[:, 0]), c=<span class="org-string">"b"</span>)
axs[1].scatter(np.<span class="org-builtin">abs</span>(lambda_target[:, 1]), np.<span class="org-builtin">abs</span>(pca_comp[:, 1]), c=<span class="org-string">"g"</span>)
<span class="org-keyword">for</span> ax <span class="org-keyword">in</span> axs.flat:
    ax.<span class="org-builtin">set</span>(xlabel=<span class="org-string">"lambda targets (abs)"</span>, ylabel=<span class="org-string">"Coord. on PCA axis (abs)"</span>)
fig.savefig(ofile)
ofile
</pre>
</div>


<figure id="orgcf58075">
<img src="outputs/sim-data-2lv/cor_lambda_coordPCA_e.png" alt="cor_lambda_coordPCA_e.png" width="600">

</figure>
</div>
</div>

<div id="outline-container-orgff4ebc0" class="outline-3">
<h3 id="orgff4ebc0"><span class="section-number-3">8.5.</span> Statistical model with sorted species</h3>
<div class="outline-text-3" id="text-8-5">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> pm.Model() <span class="org-keyword">as</span> <span class="org-variable-name">model_auto</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">Hyperpriors</span>
    sigma_alpha = pm.HalfNormal(<span class="org-string">"sigma_alpha"</span>, sigma=1.0)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Priors</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Site random effect</span>
    alpha = pm.Normal(<span class="org-string">"alpha"</span>, mu=0, sigma=sigma_alpha, shape=n_sites, dims=<span class="org-string">"sites"</span>)
    <span class="org-comment-delimiter"># </span><span class="org-comment">Latent variables</span>
    W = pm.Normal(<span class="org-string">"W"</span>, mu=0, sigma=1, shape=(n_sites, n_q), dims=(<span class="org-string">"sites"</span>, <span class="org-string">"latent_axis"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Species effects</span>
    beta = pm.Normal(<span class="org-string">"beta"</span>, mu=0, sigma=1, shape=(n_species, n_p), dims=(<span class="org-string">"species"</span>, <span class="org-string">"fixed_effects"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Factor loadings with constraints</span>
    Lambda = makeLambda(n_species, n_q, (<span class="org-string">"species"</span>, <span class="org-string">"latent_axis"</span>))
    <span class="org-comment-delimiter"># </span><span class="org-comment">Likelihood</span>
    Xbeta = pm.math.dot(X, beta.transpose())
    Wlambda = pm.math.dot(W, Lambda.transpose()) 
    logit_theta = alpha[:, np.newaxis] + Xbeta + Wlambda
    obs = pm.Bernoulli(<span class="org-string">"obs"</span>, logit_p=logit_theta, observed=Y_auto)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Inference</span>
<span class="org-keyword">with</span> <span class="org-variable-name">model_auto</span>:
    trace_auto = pm.sample(**SAMPLE_KWARGS)
</pre>
</div>

<p>
Save model with cloudpickle.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-builtin">open</span>(out_dir + <span class="org-string">"model_trace_auto.pkl"</span>, <span class="org-string">"wb"</span>) <span class="org-keyword">as</span> <span class="org-variable-name">f</span>:
    model_trace_dump = cloudpickle.dumps({<span class="org-string">'model'</span>: model_auto, <span class="org-string">'trace'</span>: trace_auto})
    f.write(model_trace_dump)
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a44c08" class="outline-3">
<h3 id="org0a44c08"><span class="section-number-3">8.6.</span> Convergence and model performance</h3>
<div class="outline-text-3" id="text-8-6">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">with</span> <span class="org-variable-name">model_auto</span>:
    alpha_est = az.summary(trace_auto, var_names=[<span class="org-string">"alpha"</span>], round_to=2)
    beta_est = az.summary(trace_auto, var_names=[<span class="org-string">"beta"</span>], round_to=2)
    lambda_est = az.summary(trace_auto, var_names=[<span class="org-string">"Lambda"</span>], round_to=2)
    lambda_0_est = az.summary(trace_auto,
                              var_names=[<span class="org-string">"Lambda"</span>],
                              coords={<span class="org-string">"latent_axis"</span>: [0]},
                              round_to=2)
    lambda_1_est = az.summary(trace_auto,
                              var_names=[<span class="org-string">"Lambda"</span>],
                              coords={<span class="org-string">"latent_axis"</span>: [1]},
                              round_to=2)
    W_est = az.summary(trace_auto, var_names=[<span class="org-string">"W"</span>], round_to=2)
    W_0_est = az.summary(trace_auto, var_names=[<span class="org-string">"W"</span>],
                         coords={<span class="org-string">"latent_axis"</span>: [0]},
                         round_to=2)
    W_1_est = az.summary(trace_auto, var_names=[<span class="org-string">"W"</span>],
                         coords={<span class="org-string">"latent_axis"</span>: [1]},
                         round_to=2)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Compute r_hat mean and std</span>
<span class="org-variable-name">rhat_alpha_mean</span> = <span class="org-builtin">round</span>(alpha_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_alpha_std</span> = <span class="org-builtin">round</span>(alpha_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_beta_mean</span> = <span class="org-builtin">round</span>(beta_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_beta_std</span> = <span class="org-builtin">round</span>(beta_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_W_mean</span> = <span class="org-builtin">round</span>(W_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_W_std</span> = <span class="org-builtin">round</span>(W_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_mean</span> = <span class="org-builtin">round</span>(lambda_est[<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_std</span> = <span class="org-builtin">round</span>(lambda_est[<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_diag_mean</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[0, 0]"</span>, <span class="org-string">"Lambda[1, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_diag_std</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[0, 0]"</span>, <span class="org-string">"Lambda[1, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].std(), 2)
<span class="org-variable-name">rhat_lambda_small_mean</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[2, 0]"</span>, <span class="org-string">"Lambda[3, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].mean(), 2)
<span class="org-variable-name">rhat_lambda_small_std</span> = <span class="org-builtin">round</span>(lambda_est.loc[[<span class="org-string">"Lambda[2, 0]"</span>, <span class="org-string">"Lambda[3, 1]"</span>], [<span class="org-string">"r_hat"</span>]][<span class="org-string">"r_hat"</span>].std(), 2)

<span class="org-comment-delimiter"># </span><span class="org-comment">Build dataframe</span>
<span class="org-variable-name">par_names</span> = [<span class="org-string">"alpha"</span>, <span class="org-string">"beta"</span>, <span class="org-string">"W"</span>, <span class="org-string">"lambda"</span>, <span class="org-string">"lambda_diag"</span>, <span class="org-string">"lambda_small"</span>]
<span class="org-variable-name">mean_val</span> = [<span class="org-builtin">eval</span>(<span class="org-string">"rhat_"</span> + x + <span class="org-string">"_mean"</span>) <span class="org-keyword">for</span> x <span class="org-keyword">in</span> par_names]
<span class="org-variable-name">std_val</span> = [<span class="org-builtin">eval</span>(<span class="org-string">"rhat_"</span> + x + <span class="org-string">"_std"</span>) <span class="org-keyword">for</span> x <span class="org-keyword">in</span> par_names]
<span class="org-variable-name">rhat_dic</span> = {<span class="org-string">"par"</span>: par_names,
            <span class="org-string">"r_hat_mean"</span>: mean_val, <span class="org-string">"rhat_std"</span>: std_val}
<span class="org-variable-name">rhat_df</span> = pd.DataFrame(rhat_dic)
tabulate(rhat_df, headers=<span class="org-string">"keys"</span>, tablefmt=<span class="org-string">"orgtbl"</span>, showindex=<span class="org-constant">False</span>)
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">par</th>
<th scope="col" class="org-right">r_hat_mean</th>
<th scope="col" class="org-right">rhat_std</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">alpha</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">beta</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">W</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">lambda</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">lambda_diag</td>
<td class="org-right">1</td>
<td class="org-right">0.01</td>
</tr>

<tr>
<td class="org-left">lambda_small</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org3b27aa9" class="outline-3">
<h3 id="org3b27aa9"><span class="section-number-3">8.7.</span> Predicted vs. target parameter values</h3>
<div class="outline-text-3" id="text-8-7">
<p>
Caution, the latent axis \(W_i\) are inverted here.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Sorted index</span>
<span class="org-builtin">id</span> = np.arange(n_species)
<span class="org-variable-name">id_sort</span> = np.copy(<span class="org-builtin">id</span>)
<span class="org-variable-name">id_sort</span>[0] = sp_sel[0]
<span class="org-variable-name">id_sort</span>[1] = sp_sel[1]
id_sort[<span class="org-variable-name">sp_sel</span>[0]] = 0
id_sort[<span class="org-variable-name">sp_sel</span>[1]] = 1
<span class="org-builtin">id</span> = id_sort

<span class="org-comment-delimiter"># </span><span class="org-comment">alpha</span>
<span class="org-variable-name">f</span> = out_dir + <span class="org-string">"alpha_auto.png"</span>
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(figsize=(6, 6))
ax.scatter(alpha_target, alpha_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"alpha_auto"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">beta</span>
f = out_dir + <span class="org-string">"beta_auto.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
beta_hat = np.asarray(beta_est[<span class="org-string">"mean"</span>]).reshape(n_species, n_p)[<span class="org-builtin">id</span>, :]
ax.scatter(beta_target.flatten(), beta_hat.flatten(), c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"beta_auto"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_0</span>
f = out_dir + <span class="org-string">"W_0_auto.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(W_target[:, 0], W_0_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_0_auto"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_1</span>
f = out_dir + <span class="org-string">"W_1_auto.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(W_target[:, 1], W_1_est[<span class="org-string">"mean"</span>], c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_1_auto"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">lambda_0</span>
f = out_dir + <span class="org-string">"lambda_0_auto.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
lambda_0_hat = lambda_0_est[<span class="org-string">"mean"</span>][<span class="org-builtin">id</span>]
ax.scatter(lambda_target[:, 0], lambda_0_hat, c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"lambda_0_auto"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">lambda_1</span>
f = out_dir + <span class="org-string">"lambda_1_auto.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
lambda_1_hat = lambda_1_est[<span class="org-string">"mean"</span>][<span class="org-builtin">id</span>]
ax.scatter(lambda_target[:, 1], lambda_1_hat, c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.axline((-1, 1), slope=-1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"lambda_1_auto"</span>)
fig.savefig(f)

<span class="org-comment-delimiter"># </span><span class="org-comment">W_lambda</span>
lambda_hat = np.asarray(lambda_est[<span class="org-string">"mean"</span>]).reshape(n_species, n_q)[<span class="org-builtin">id</span>, :]
W_lambda_est = np.matmul(
    np.asarray(W_est[<span class="org-string">"mean"</span>]).reshape(n_sites, n_q),
    lambda_hat.transpose())
f = out_dir + <span class="org-string">"W_lambda_auto.png"</span>
fig, ax = plt.subplots(figsize=(6, 6))
ax.scatter(Wlambda_target.flatten(), W_lambda_est.flatten(), c=<span class="org-string">".3"</span>)
ax.axline((1, 1), slope=1, ls=<span class="org-string">"--"</span>, c=<span class="org-string">".3"</span>)
ax.set_title(<span class="org-string">"W_lambda_auto"</span>)
fig.savefig(f)
</pre>
</div>


<figure id="orgcbc9446">
<img src="outputs/sim-data-2lv/W_0.png" alt="W_0.png" width="375" style="float:left;">

</figure>


<figure id="org9971c23">
<img src="outputs/sim-data-2lv/W_0_auto.png" alt="W_0_auto.png" width="375">

</figure>


<figure id="orgac502c3">
<img src="outputs/sim-data-2lv/W_1.png" alt="W_1.png" width="375" style="float:left;">

</figure>


<figure id="org1100d9f">
<img src="outputs/sim-data-2lv/W_1_auto.png" alt="W_1_auto.png" width="375">

</figure>


<figure id="orgdd4e632">
<img src="outputs/sim-data-2lv/lambda_0.png" alt="lambda_0.png" width="375" style="float:left;">

</figure>


<figure id="org656e43e">
<img src="outputs/sim-data-2lv/lambda_0_auto.png" alt="lambda_0_auto.png" width="375">

</figure>


<figure id="orge8e36ea">
<img src="outputs/sim-data-2lv/lambda_1.png" alt="lambda_1.png" width="375" style="float:left;">

</figure>


<figure id="orgd0f75f7">
<img src="outputs/sim-data-2lv/lambda_1_auto.png" alt="lambda_1_auto.png" width="375">

</figure>


<figure id="org7be01e9">
<img src="outputs/sim-data-2lv/W_lambda.png" alt="W_lambda.png" width="375" style="float:left;">

</figure>


<figure id="org3894a72">
<img src="outputs/sim-data-2lv/W_lambda_auto.png" alt="W_lambda_auto.png" width="375">

</figure>
</div>
</div>
</div>
</div>
</body>
</html>